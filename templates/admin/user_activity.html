{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .activity-container {
        padding: 20px;
    }
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-box {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    .stat-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-box.updating {
        background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    .stat-box h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
    }
    .stat-number {
        font-size: 36px;
        font-weight: bold;
        color: #0066cc;
        transition: color 0.3s;
    }
    .activity-section {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .activity-section h2 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        color: #333;
    }
    .user-list {
        list-style: none;
        padding: 0;
        margin: 15px 0 0 0;
    }
    .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    .user-item:hover {
        background-color: #f8f9fa;
    }
    .user-item:last-child {
        border-bottom: none;
    }
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }
    .user-details {
        display: flex;
        flex-direction: column;
    }
    .username {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    .user-email {
        color: #666;
        font-size: 12px;
    }
    .timestamp {
        color: #999;
        font-size: 12px;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-online {
        background-color: #d4edda;
        color: #155724;
    }
    .status-active {
        background-color: #cce5ff;
        color: #004085;
    }
    .status-new {
        background-color: #fff3cd;
        color: #856404;
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    .chart-control-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
    }
    .chart-control-btn:hover {
        background: #e9ecef;
    }
    .chart-control-btn.active {
        background: #0066cc;
        color: white;
        border-color: #0066cc;
    }
</style>
{% endblock %}

{% block content %}
<div class="activity-container" x-data="userActivityApp()">
    <h1>👥 사용자 활동 모니터링</h1>
    
    <!-- 자동 새로고침 컨트롤 -->
    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
        <label style="display: inline-flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh()">
            <span>실시간 모니터링 (3초마다 갱신)</span>
        </label>
        <div x-show="isLoading" class="htmx-indicator" style="display: none;"></div>
        <span x-show="lastUpdate" style="color: #666; font-size: 14px;">
            마지막 업데이트: <span x-text="lastUpdate"></span>
        </span>
    </div>
    
    <!-- 통계 카드 - Alpine.js로 관리 -->
    <div class="stats-row">
        <div class="stat-box" :class="{ 'updating': stats.updating }">
            <h3>전체 사용자</h3>
            <div class="stat-number" x-text="stats.total_users">{{ total_users }}</div>
        </div>
        <div class="stat-box" :class="{ 'updating': stats.updating }">
            <h3>현재 온라인</h3>
            <div class="stat-number" x-text="stats.online_users">{{ online_users }}</div>
        </div>
        <div class="stat-box" :class="{ 'updating': stats.updating }">
            <h3>오늘 가입</h3>
            <div class="stat-number" x-text="stats.new_users_today">{{ recent_users|length }}</div>
        </div>
        <div class="stat-box" :class="{ 'updating': stats.updating }">
            <h3>오늘 활동</h3>
            <div class="stat-number" x-text="stats.active_today">{{ recent_logins|length }}</div>
        </div>
    </div>
    
    <!-- 탭 컨트롤 -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <button @click="activeTab = 'login'" 
                :class="{ 'active': activeTab === 'login' }"
                class="chart-control-btn"
                style="padding: 8px 16px;">
            최근 로그인
        </button>
        <button @click="activeTab = 'signup'" 
                :class="{ 'active': activeTab === 'signup' }"
                class="chart-control-btn"
                style="padding: 8px 16px;">
            최근 가입
        </button>
    </div>
    
    <!-- 사용자 목록 - HTMX로 동적 로드 -->
    <div id="user-lists">
        <!-- 로그인 사용자 목록 -->
        <div x-show="activeTab === 'login'"
             hx-get="{% url 'admin:admin_api_user_activity_list' %}?type=login"
             hx-trigger="load, every 3s[autoRefresh && activeTab === 'login']"
             hx-swap="innerHTML">
            {% include 'admin/partials/user_activity_list.html' with list_type='login' title='최근 로그인 사용자' users=recent_logins %}
        </div>
        
        <!-- 가입 사용자 목록 -->
        <div x-show="activeTab === 'signup'"
             hx-get="{% url 'admin:admin_api_user_activity_list' %}?type=signup"
             hx-trigger="load, every 3s[autoRefresh && activeTab === 'signup']"
             hx-swap="innerHTML">
            {% include 'admin/partials/user_activity_list.html' with list_type='signup' title='최근 가입 사용자' users=recent_users %}
        </div>
    </div>
</div>

<script>
// Alpine.js 앱
function userActivityApp() {
    return {
        autoRefresh: false,
        activeTab: 'login',
        lastUpdate: null,
        isLoading: false,
        stats: {
            total_users: {{ total_users }},
            online_users: {{ online_users }},
            new_users_today: {{ recent_users|length }},
            active_today: {{ recent_logins|length }},
            updating: false
        },
        refreshInterval: null,
        
        init() {
            // HTMX 이벤트 리스너
            document.body.addEventListener('htmx:beforeRequest', () => {
                this.isLoading = true;
            });
            
            document.body.addEventListener('htmx:afterRequest', () => {
                this.isLoading = false;
                this.updateTimestamp();
            });
            
            // 초기 데이터 로드
            this.loadStats();
        },
        
        toggleAutoRefresh() {
            if (this.autoRefresh) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        },
        
        startAutoRefresh() {
            // 통계 데이터 자동 새로고침
            this.refreshInterval = setInterval(() => {
                this.loadStats();
            }, 3000);
        },
        
        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
                this.refreshInterval = null;
            }
        },
        
        async loadStats() {
            this.stats.updating = true;
            
            try {
                const response = await fetch('{% url "admin:admin_api_user_activity_data" %}');
                const data = await response.json();
                
                // 애니메이션 효과를 위한 약간의 지연
                setTimeout(() => {
                    this.stats.total_users = data.total_users;
                    this.stats.online_users = data.online_users;
                    this.stats.new_users_today = data.recent_users.length;
                    this.stats.active_today = data.recent_logins.length;
                    this.stats.updating = false;
                    this.updateTimestamp();
                }, 300);
            } catch (error) {
                console.error('Failed to load stats:', error);
                this.stats.updating = false;
            }
        },
        
        updateTimestamp() {
            const now = new Date();
            this.lastUpdate = now.toLocaleTimeString('ko-KR');
        }
    }
}
</script>
{% endblock %}